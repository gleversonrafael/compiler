import{onSnapshot as e,query as t,where as s,getDocs as r,doc as a,setDoc as l,updateDoc as n,deleteDoc as o}from"firebase/firestore";import{db as c,usersCol as i}from"../general/jsfirebase.js";import{currentUserBasicInformation as d}from"../general/jsuserdata.js";import{showMessageBox as u,toggleModal as m,setReusableEvents as g}from"../general/jsreusablestructures.js";import{closeBox as E,showCourses as f}from"./jsmanageandmycourses.js";document.location.href.includes("manage")&&createManageCoursesEvents();let deleteCourseState,deletedCourses=[],canEditAcess;function createManageCoursesEvents(){g(["formsEvent","cancelModalEvent"]),document.getElementById("addCourseButton").addEventListener("click",async()=>{await m("createCourseModal"),changeCourseBoxPage(1)}),document.getElementById("returnCreateCourse").addEventListener("click",()=>{changeCourseBoxPage(1)}),document.getElementById("acessB").addEventListener("click",e=>{e.preventDefault(),changeCourseBoxPage(2)}),document.getElementById("createCourseForm").addEventListener("submit",async e=>{e.preventDefault(),createCourse()}),acessOperations("createEvents"),deleteCourses("createEvents"),validateFields("createEvents")}function changeCourseBoxPage(e){let t=document.getElementById("createCourseForm"),s=document.getElementById("usersWithAcessPage"),r=document.querySelector(".createdBoxSubtitle"),a=document.getElementById("returnCreateCourse");switch(e){case 1:r.innerText="Dados principais",a.style.display="none",t.style.display="flex",s.style.display="none";break;case 2:r.innerText="Usu\xe1rios com permiss\xe3o",a.style.display="flex",t.style.display="none",s.style.display="flex",0==document.getElementById("userList").childElementCount&&loadUserList();break;default:console.log("page Error")}}function loadUserList(){let r=document.getElementById("userList"),a=t(i,s("uid","!=",d.uid),s("deleted","==",!1));e(a,e=>{e.forEach(e=>{let t={name:e.data().name,email:e.data().email,uid:e.data().uid};!function e(t){let s={usernameP:document.createElement("p"),useremailP:document.createElement("p"),genericLi:document.createElement("li")};s.usernameP.textContent=t.name,s.useremailP.textContent=t.email,s.usernameP.classList.add("username"),s.useremailP.classList.add("useremail"),s.genericLi.id=t.uid,s.genericLi.appendChild(s.usernameP),s.genericLi.appendChild(s.useremailP),r.appendChild(s.genericLi)}(t)})})}function acessOperations(e){"createEvents"===e&&(document.getElementById("grantAcessButton").addEventListener("click",()=>{canEditAcess=!0!=canEditAcess,t("grant")}),document.getElementById("removeAcessButton").addEventListener("click",()=>{canEditAcess=!0!=canEditAcess,t("remove")}));function t(e){let t=document.getElementById("grantAcessButton"),s=document.getElementById("removeAcessButton");function r(t){let s=t.currentTarget;s.classList.contains("editableBox")&&("grant"===e?s.classList.add("acessGranted"):s.classList.remove("acessGranted"),s.classList.remove("editableBox")),s.removeEventListener("click",r)}(function a(){let l=document.querySelectorAll("#userList > li");for(let n=0;n<l.length;n++)l[n].classList.contains("editableBox")&&(t.hasAttribute("disabled")||s.hasAttribute("disabled"))?l[n].classList.remove("editableBox"):("grant"===e&&!l[n].classList.contains("acessGranted")||"remove"===e&&l[n].classList.contains("acessGranted"))&&(l[n].classList.add("editableBox"),l[n].addEventListener("click",r))})(),!0===canEditAcess?"grant"===e?s.setAttribute("disabled",""):t.setAttribute("disabled",""):"grant"===e?s.removeAttribute("disabled"):t.removeAttribute("disabled")}}function createCourse(){let e,t,s;!0===validateFields("multiple","","createCourseForm")?(e=document.getElementById("courseNameInp").value,t=document.getElementById("coursePlatformInp").value,l(a(c,"courses",function e(t,s,r){let a,l=0;for(t=(t=t.trim()).substring(0,4),s=s.substring(0,4);l<1e3||l>=1e4;)l=Math.floor(1e4*Math.random());return`c${(a=r?"f":"e")+l+t+s}`}(e,t,s=document.getElementById("imgInp").value)),{courseName:e,coursePlatform:t,email:document.getElementById("emailInp").value,userPassword:document.getElementById("userPasswordInp").value,url:document.getElementById("urlInp").value,img:s,creator:d.uid,usersWithAcess:function e(){let t=[],s=document.querySelectorAll("#userList > .acessGranted");for(let r=0;r<s.length;r++)t.push(s[r].id);return t}()}),u("successMessage","Curso criado!"),document.getElementById("createCourseForm").reset(),document.querySelectorAll("#createCourseForm .correctInput").forEach(e=>e.classList.remove("correctInput")),document.querySelectorAll("#createCourseModal .acessGranted").forEach(e=>e.classList.remove("acessGranted"))):u("errorMessage","Preencha corretamente os campos!")}async function deleteCourses(e){let t=document.getElementById("addCourseButton"),s=document.getElementById("confirmExclusion");if("createEvents"===e)document.getElementById("deleteCourseButton").addEventListener("click",()=>{let e;!0!=deleteCourseState?(deleteCourseState=!0,function e(){let t=document.querySelectorAll(".coursesColumn > div");for(let s=0;s<t.length;s++)!0===deleteCourseState?(t[s].classList.add("canBeDeleted"),t[s].addEventListener("click",d)):(t[s].removeAttribute("class"),t[s].removeEventListener("click",d))}(),!0===deleteCourseState?t.setAttribute("disabled",""):t.removeAttribute("disabled")):(deletedCourses=[],document.querySelectorAll(".willBeDeleted").forEach(e=>{deletedCourses.push(e.id)}),function e(){let t=document.getElementById("deletedCoursesCounter");if(deletedCourses.length>0){let r=deletedCourses.length>1?"cursos":"curso";t.innerText=`Deseja excluir ${deletedCourses.length} ${r}?`,s.removeAttribute("disabled")}else t.innerText="N\xe3o h\xe1 cursos a serem exclu\xeddos.",s.setAttribute("disabled","")}(),m("deleteCourseModal"))}),s.addEventListener("click",async()=>{g(!1),await deleteCourses(),deletedCourses=[]}),document.getElementById("cancelExclusion").addEventListener("click",()=>{!0===deleteCourseState&&(g(!1),deletedCourses=[])}),document.getElementById("changeExclusion").addEventListener("click",()=>{!0===deleteCourseState&&g(!0)});else{let r=0,l,n;for(let i=0;i<deletedCourses.length;i++)await o(a(c,"courses",deletedCourses[i])),r+=1;r===deletedCourses.length?(l="Todos os cursos selecionados foram apagados.",n="successMessage"):(l="Nenhum ou apenas alguns dos cursos selecionados foram apagados.",n="errorMessage"),u(n,l),await f(void 0,"my")}function d(e){let t=e.currentTarget;t.classList.contains("canBeDeleted")?(t.classList.remove("canBeDeleted"),t.classList.add("willBeDeleted")):(t.classList.remove("willBeDeleted"),t.classList.add("canBeDeleted"))}function g(e){m("deleteCourseModal"),!0!=e&&(t.removeAttribute("disabled"),deleteCourseState=!1,document.querySelectorAll(".canBeDeleted, .willBeDeleted").forEach(e=>{e.removeAttribute("class"),e.removeEventListener("click",d)}))}}function validateFields(e,t,s){switch(e){case"createEvents":!function e(){let t=document.querySelectorAll("#createCourseForm > .contentFieldset > input");t=Array.from(t);for(let s=0;s<t.length;s++)t[s].onchange=()=>{validateFields("single",[t[s]],"createCourseForm")}}();break;case"single":t.forEach(e=>{let t=e.dataset.relatedfield,s=e.value,r=e.classList,a;switch(t){case"courseName":a=/[\w]{2,}/;break;case"email":a=/^$|[\w]{2,}[@][a-z]{2,}[.][a-z]{2,}/;break;case"userPassword":a=/^$|[\w\d]{4,}/;break;case"url":a=/https?:\/\/.+\..+/;break;case"img":a=/^$|https?:\/\/.+\..+/;default:a=/^$|.{1,}/}!0===a.test(s)?(r.contains("incorrectInput")&&r.remove("incorrectInput"),r.add("correctInput")):e.classList.contains("correctInput")&&(r.remove("correctInput"),r.add("incorrectInput"))});break;case"multiple":return!0===function e(){let t=document.querySelectorAll(`#${s} .requiredInput.correctInput`),r=document.querySelectorAll(`#${s} .requiredInput`).length;return t.length===r}();default:console.log("Something unexpected on validating inputs ocurred. A wrong call was been received.")}}async function saveCourseData(e,t){let s,r=(s={},function r(){let a=Object.entries(t);a.forEach(t=>{let r=t[0],a=t[1],l,n;if("usersWithAcess"!=r&&"creator"!=r)n=l=document.getElementById(r+e).value;else if("usersWithAcess"===r){let o=Array.from(document.querySelectorAll(`#${e} .acessEditToggled`));for(let c=0;c<o.length;c++)o[c]=o[c].id.slice(e.length+4);n=JSON.stringify(l=o),a=JSON.stringify(a)}"creator"!=r&&a!==n&&Object.defineProperty(s,r,{value:l,enumerable:!0})})}(),s),l=Object.keys(r).length>0,o=0===document.querySelectorAll(`#${e} .incorrectInput`).length;if(l&&o){let i=a(c,"courses",e);await n(i,r).then(()=>{u("successMessage","Curso alterado! atualize para visualizar as mudan\xe7as. "),E(e,"withTargetDefined")}).catch(e=>{u("errorMessage","Houve um erro ao salvar esse curso."),console.log(e.code)})}else u("errorMessage",l?"Preencha corretamente os dados do curso!":"Nenhum dado do curso foi alterado.")}async function createAcessControl(e,a){let l=document.createElement("div"),n=document.createElement("ul");async function o(){let a,o,c=document.createElement("h3");c.innerText="Usu\xe1rios com acesso";let u=t(i,s("uid","!=",d.uid),s("deleted","==",!1));await r(u).then(t=>{t.forEach(t=>{let s=t.data(),r=document.createElement("li");r.addEventListener("click",()=>{(function e(t){let s=t.classList;s.add("changedJS"),s.contains("acessEditToggled")?s.remove("acessEditToggled"):s.add("acessEditToggled")})(r)}),r.innerText=s.email,r.id="edit"+e+s.uid,n.appendChild(r)}),a=document.querySelector(`div#${e} > .createdContent`),o=document.querySelector(`div#${e} > .createdContent > .stepperGroup`)}).catch(e=>{console.log(e)}),l.appendChild(c),l.appendChild(n),a.insertBefore(l,o)}l.classList.add("acessControl","coursePage4","aCoursePage"),n.classList.add("thisCourseAcess"),await o(),a.length>0&&function t(){for(let s=0;s<a.length;s++)if(a[s]!=d.uid){let r=`edit${e+a[s]}`;document.getElementById(r).classList.add("acessEditToggled")}}()}export{createAcessControl,saveCourseData,validateFields};