import{initializeApp}from"firebase/app";import{getDoc,getDocs,setDoc,updateDoc,doc,query,where,onSnapshot}from"firebase/firestore";import{firebaseConfig,db,usersCol }from"./general/jsfirebase.js";import {createUserWithEmailAndPassword,signOut,getAuth}from"firebase/auth";import{currentUserBasicInformation}from"./general/jsuserdata.js";import{setFunctionsOnLoad, removeSkeletons}from"./general/jsload.js";import{setReusableEvents,convertHtmlStringToElement,showMessageBox,toggleModal,customUpdateDocument,userDataIsValid,obtainUserInputedData,createUserDataArray,convertSpecificArrayIntoObject,obtainFather,fillSelectedForm,forEachPropertyWithDo,generatePasswordHash}from"./general/jsreusablestructures.js";setManageUsersEvents();setReusableEvents(["formsEvent","cancelModalEvent"]);await refreshTableWithNewData();setFunctionsOnLoad([removeSkeletons]);async function refreshTableWithNewData(e){let t;if(e||(e=await r()),"ERROR"!==e)return fillTable("usersTable",t=obtainDocumentsArray(e),"users"),!0;return!1;async function r(){let e=query(usersCol,where("uid","!=",currentUserBasicInformation.uid),where("deleted","==",!1)),t;return await getDocs(e).then(e=>{t=e}).catch(e=>{showMessageBox("errorMessage","N\xe3o foi poss\xedvel recarregar a tabela."),console.log(e.code),t="ERROR"}),t}}async function fillTable(e,t,r){let a=document.querySelector(`#${e} .tableBody`);a.innerHTML="";for(let s=0;s<t.length;s++){let o=document.createElement("tr");o.classList.add("tableRowCSS"),r&&i(r,o,t[s]),a.appendChild(o)}function i(e,t,r){if("users"===e){var a;let s=r[0],o=r[1],i="admin"===o.usertype?"Administrador":"Usu\xe1rio comum",d={MainText:o.name,Subtext:o.email,EmphasisText:i};t.id=`userIdentifier${s}`,t.classList.add(`${o.usertype}User`,!0===o.active?"activeUser":"inactiveUser"),!0===o.deleted&&t.classList.add("deleted");let l,n=(a=d,l=document.createElement("td"),l.classList.add("textCell"),forEachPropertyWithDo({selectedObject:a,functionsArray:[function e(t,r){let a=`<p class="table${t} textOverflowCSS"> ${r} </p>`,s=convertHtmlStringToElement(a);l.appendChild(s)}]}),l);t.appendChild(n);let u,c=(u=document.createElement("td"),u.classList.add("userActionsCell"),["toggleUserInput","editUserInput","deleteUserInput"].forEach(e=>{let a=function e(t,a){let s=t.id.replace(/userIdentifier/,""),o=document.createElement("input"),i,d;if(o.type="button",o.classList.add(a,"squareButtonWithImage"),a.includes("delete")){let l=t.querySelector(".tableMainText").innerText;i=showUserDeleteBox,d={userName:l,userUID:s}}else if(a.includes("edit")){let{password:n,...u}=r[1];i=showAndRestartEditUserBox,d={userUID:s,userData:u}}else{let c=!t.classList.contains("activeUser");i=customUpdateDocument,d={selectedCollection:"usersInfo",documentId:s,newData:{active:c},errorMessage:`O usu\xe1rio selecionado previamente n\xe3o foi ${!0!==c}`}}return o.addEventListener("click",()=>{i(d)}),o}(t,e);u.appendChild(a)}),u);t.appendChild(c)}}}function setManageUsersEvents(){let e=document.getElementById("createUserForm");e.addEventListener("submit",()=>{createNewUser(e)}),document.getElementById("openSignModal").addEventListener("click",()=>{toggleModal("signUsersModal")}),document.querySelector("#deleteUserModal .confirmFormJS").addEventListener("click",()=>{deleteUserSubmit()}),document.querySelector("#editUserForm").addEventListener("submit",()=>{let e=document.querySelector("#editUserForm");submitUserSaveData({selectedForm:"editUserForm",oldDataDocumentId:e.dataset.selecteduseruid,obtainDataTries:0})})}async function createNewUser(e){let t=obtainUserInputedData("createUserForm"),r=createUserDataArray("create",t),a=convertSpecificArrayIntoObject(r),s=userDataIsValid(r),o="errorMessage",i,d;async function l(){if(s){let e=await n(a);if(!0===e.result){let t=`u${e.returnedUID}`;Object.defineProperty(a,"uid",{value:t,enumerable:!0}),a.password=generatePasswordHash(a.password),await u(t,a).then(e=>{d=e})}else{let r;i=r="auth/email-already-in-use"===e.errorCode?"Esse e-mail j\xe1 est\xe1 em uso!":"Um erro desconhecido no cadastramento de usu\xe1rio ocorreu."}}else i=s?"Selecione o tipo de usu\xe1rio!":"Preencha os dados do usu\xe1rio corretamente!"}async function n(e){let t=initializeApp(firebaseConfig,"signApp"),r=getAuth(t),a={result:!1,returnedUID:null,errorCode:null};return await createUserWithEmailAndPassword(r,e.email,e.password).then(e=>{a.returnedUID=e.user.uid,a.result=!0}).catch(e=>{a.errorCode=e.code}),await signOut(r),a}async function u(e,t){let r;return await setDoc(doc(db,"usersInfo",e),t).then(()=>{o="successMessage",i="O usu\xe1rio foi criado com sucesso!",r=!0}).catch(e=>{o="strangeMessage",i="A autenticiadde do usu\xe1rio foi cadastrada, sem um local definido no banco de dados.",console.log(`ERROR: ${e.code}`),r=!1}),r}await l(),showMessageBox(o,i),!0===d&&e.reset()}async function deleteUserSubmit(){let e=document.querySelector("#deleteUserModal"),t=e.dataset.selecteduseruid,r=await customUpdateDocument({documentId:t,selectedCollection:"usersInfo",newData:{deleted:!0},desiredMessage:"O usu\xe1rio foi exclu\xeddo da plataforma!",errorMessage:"O usu\xe1rio n\xe3o foi exclu\xeddo. Tente novamente."});!0===r.result&&(toggleModal("deleteUserModal"),e.removeAttribute("data-selecteduseruid"))}function showUserDeleteBox(e){let t=document.querySelector("#deleteUserModal"),r=document.querySelector("#deleteUserModal .displayTextJS");t.setAttribute("data-selecteduseruid",e.userUID),r.innerText=e.userName,toggleModal("deleteUserModal")}async function submitUserSaveData(e){let t,r,a,s,o=!1,i=e.oldDataDocumentId,d=doc(db,"usersInfo",i),l=await getDoc(d);if(l.exists()){let n;if(l=l.data(),(t=(n=obtainUserInputedData(e.selectedForm),createUserDataArray("edit",n,l))).length>0&&userDataIsValid(t)){let u=convertSpecificArrayIntoObject(t);await c(u),!0===o&&await refreshTableWithNewData(),toggleModal(s.id)}else a="errorMessage",r=0===t.length?"Altere os dados desse usu\xe1rio para salvar as altera\xe7\xf5es!":"Preencha corretamente os dados do usu\xe1rio!";showMessageBox(a,r)}else e.obtainDataTries+=1,e.obtainDataTries<3?submitUserSaveData(e):showMessageBox("errorMessage","N\xe3o foi poss\xedvel obter os dados anteriores desse usu\xe1rio e, portanto, atualiz\xe1-lo no momento."),console.log("dataRequestFailure"+e.obtainDataTries);async function c(t){await updateDoc(d,t).then(()=>{o=!0,r="Usu\xe1rio alterado!",s=obtainFather(document.getElementById(e.selectedForm),"modalJS")}).catch(e=>{r="N\xe3o foi poss\xedvel salvar os dados do usu\xe1rio.",console.log(`ERROR${e.code}`)}),a=!0===o?"successMessage":"errorMessage"}}function showAndRestartEditUserBox(e){let t=document.querySelector("form#editUserForm"),r=document.querySelector(`input[data-relatedfield=usertype-${e.userData.usertype}]`),a=document.querySelector("form#editUserForm .formResetJS"),s={formId:"editUserForm",newData:e.userData,radiosToFill:[r]};t.dataset.selecteduseruid=e.userUID,a.onclick=function e(t){t.preventDefault(),restartForm(s)},restartForm(s),toggleModal("editUserModal")}function restartForm(e){fillSelectedForm({selectedFormId:e.formId,data:e.newData});for(let t=0;t<e.radiosToFill.length;t++)e.radiosToFill[t].checked=!0}function obtainDocumentsArray(e){let t=[];return e.forEach(e=>{let r=[];r[0]=e.id,r[1]=e.data(),t.push(r)}),t}onSnapshot(usersCol,async()=>{await refreshTableWithNewData()});