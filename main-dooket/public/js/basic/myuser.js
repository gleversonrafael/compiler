import{fetchOwnUserData as e,currentUserBasicInformation as a}from"./general/jsuserdata.js";import{setReusableEvents as s,showMessageBox as r,userDataIsValid as o,checkUserPassword as t,generatePasswordHash as n,createUserDataArray as l,obtainArrayFromInputs as i,convertSpecificArrayIntoObject as d,toggleModal as c}from"./general/jsreusablestructures.js";import{removeSkeletons as u}from"./general/jsload.js";import{updateDoc as f,doc as m}from"firebase/firestore";import{EmailAuthProvider as w,updatePassword as g,updateEmail as v,reauthenticateWithCredential as h,signOut as p}from"firebase/auth";import{db as y,auth as P}from"./general/jsfirebase.js";let newAssignedPassword=null,oldPassword;async function loadDefaults(){await fillFieldsWithUserData(),toggleEvents(),saveUserDataProcess("setEvents"),u()}function toggleEvents(){s(["formsEvent","cancelModalEvent"]),document.getElementById("changePasswordButton").addEventListener("click",()=>{c("changePasswordModal")}),document.getElementById("changeOwnUserData").addEventListener("submit",()=>{saveUserDataProcess()}),document.getElementById("changePassword").addEventListener("submit",()=>{temporarilyChangeUserPassword()}),document.getElementById("deleteAccount").addEventListener("click",()=>{c("deleteOwnUserModal")}),document.querySelector("form#deleteOwnUser").addEventListener("submit",()=>{deleteOwnUser()})}async function fillFieldsWithUserData(){let{password:a,...s}=await e(),r=document.querySelectorAll("#changeOwnUserData .fillableInputJS");for(let o=0;o<r.length;o++){let t=r[o].name;s[t]&&(r[o].placeholder=s[t],r[o].value=s[t])}}async function temporarilyChangeUserPassword(){let e=document.getElementById("changeCurrentPasswordInput").value,a=document.getElementById("newPasswordInput").value,s=await t(e);!0===s&&!0===o([{password:a}])?(document.querySelector("form#changePassword").reset(),oldPassword=e,newAssignedPassword=a,c("changePasswordModal"),r("strangeMessage","Salve seus dados para completar a redefini\xe7\xe3o de senha.")):!1===s?r("errorMessage","Senha atual incorreta!"):r("errorMessage","A nova senha inserida n\xe3o se adequa aos padr\xf5es de uso.")}async function saveUserDataProcess(s,u){let p,$,E;if("setEvents"===s)document.querySelector("form#confirmPassword").addEventListener("submit",async e=>{e.preventDefault(),await I("confirmPassword")===!0&&(oldPassword=document.getElementById("verifyPasswordInput").value,c("confirmPasswordModal"),saveUserDataProcess("",!0))});else{let{password:b,...U}=await e(),D=i("changeOwnUserData");if(p=await l("edit",D,U),null!=newAssignedPassword&&(p.push({password:newAssignedPassword}),newAssignedPassword=null),$=d(p),!0===(E=function e(){let a={correct:!1,type:!1};if(p.length>0&&o(p)){let s;Object.defineProperties(a,{correct:{value:!0,writable:!0},type:{value:s=$.email||$.password?"confidential":"safe",writable:!0}})}else Object.defineProperties(a,{correct:{value:!1,writable:!0},type:{value:0===p.length?"noChange":"incorrectData",writable:!0}});return a}()).correct)!0==u||"confidential"!==E.type||$.password?!0!=u&&(u=!0):c("confirmPasswordModal"),!0===u&&M(E.type,$);else{let A;switch(E.type){case"noChange":A="Nenhum dado foi alterado.";break;case"incorrectData":A="Preencha corretamente seus dados!";break;default:A="Um erro fora dos padr\xf5es foi encontrado."}r("errorMessage",A)}}async function I(){let e=!1,a=document.getElementById("verifyPasswordInput").value,s=document.querySelectorAll("form#confirmPassword .confirmJS");s=Array.from(s);let o=confirmNFields(s,a);return!0===o&&await t(a)===!0?(c("confirmPasswordModal"),oldPassword=a,e=!0):!1===o?r("errorMessage","As senhas informadas se contradizem."):r("errorMessage","A senha informada n\xe3o coincide com \xe0 do usu\xe1rio"),e}async function M(s,o){let t=m(y,"usersInfo",a.uid),l=P.currentUser,i,d={},c,u;if("confidential"===s){let{email:p}=await e(),$;await h(l,i=w.credential(p,oldPassword)).then(()=>{$=!0}).catch(e=>{$=!1,console.log(`Erro ao obter acesso para salvar e-mail e/ou senha. C\xd3D: ${e.code}`)}),!0===$&&(o.email&&await E(),o.password&&await b(),c=Object.values(d))}async function E(){await v(l,o.email).then(()=>{u=!0}).catch(e=>{console.log("ERRO: O e-mail do usu\xe1rio n\xe3o foi salvo. C\xd3D:"+e.code),u=!1}),Object.defineProperty(d,"email",{value:u,enumerable:!0})}async function b(){await g(l,o.password).then(()=>{u=!0,Object.defineProperty(o,"password",{value:n(o.password),enumerable:!0})}).catch(()=>{console.log("ERRO: A senha do usu\xe1rio n\xe3o foi salva."),u=!1}),Object.defineProperty(d,"password",{value:u,enumerable:!0})}("safe"===s||!0===confirmNFields(c,!0))&&await f(t,o).then(()=>{window.location.reload()}).catch(e=>{r("Houve um erro na submiss\xe3o dos dados"),console.log("database"+e.code)})}}async function deleteOwnUser(){if(await confirmUserPassword("deleteOwnUser")===!0){let e=m(y,"usersInfo",a.uid);f(e,{deleted:!0}).then(()=>{c("deleteOwnUser"),p(P)})}}function confirmNFields(e,a){let s=!0;for(let r=0;r<e.length;r++)if((void 0!=e[r].value?e[r].value:e[r])!=a){s=!1;break}return s}async function confirmUserPassword(e){let a=!1,s=document.querySelector(`form#${e} .firstPasswordJS`).value,o=document.querySelectorAll(`form#${e} .confirmJS`);o=Array.from(o);let n=confirmNFields(o,s);return!0===n&&await t(s)===!0?a=!0:!1===n?r("errorMessage","As senhas informadas se contradizem."):r("errorMessage","A senha informada n\xe3o coincide com \xe0 do usu\xe1rio"),a}function removeElementsCertainClass(e,a){e.forEach(e=>{e.classList.remove(a)})}document.body.addEventListener("load",await loadDefaults());